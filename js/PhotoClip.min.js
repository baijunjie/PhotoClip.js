/* PhotoClip v3.2.1 | (c) 2014-2017 BaiJunjie | MIT Licensed | Relying on the plug-in [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(t,i){"use strict";"object"==typeof module&&"object"==typeof exports?module.exports=i(require("./iscroll-zoom"),require("./hammer.min"),require("./lrz.all.bundle")):"function"==typeof define&&define.amd?define(["iscroll-zoom","hammer","lrz"],i):t.PhotoClip=i(t.IScroll,t.Hammer,t.lrz)}(this,function(t,i,o){"use strict";function e(t,i){if(!(this instanceof e))return new e(i);(t=$(t))&&t.length&&(this._$container=t[0],this._options=u(!0,{},E,i),void 0===H&&this._options.errorMsg.noSupport&&alert(this._options.errorMsg.noSupport),this._init())}function r(t,i,o,e){var r=t/o,n=i/e;return r>n?r:n}function n(t,i,o){i=(i||0).toFixed(2),o=(o||0).toFixed(2),b(t,H+"transform-origin",i+"px "+o+"px")}function a(t,i,o,e){i=i.toFixed(2),o=o.toFixed(2),e=e.toFixed(2),b(t,H+"transform","translateZ(0) translate("+i+"px,"+o+"px) rotate("+e+"deg)")}function s(t,i,o,e,r,n){b(t,H+"transform"),b(t,H+"transition",H+"transform "+r+"ms cubic-bezier(0.1, 0.57, 0.1, 1)"),a(t,i,o,e),setTimeout(function(){b(t,H+"transition",""),n()},r)}function h(t,i){var o=l(i),e=Math.sin(o),r=Math.cos(o);return{x:r*t.x-e*t.y,y:r*t.y+e*t.x}}function l(t){return t/180*Math.PI}function c(t,i,o,e){o=o||0,e=e||0;var r,n;return g([t,i],function(){r=t.getBoundingClientRect(),n=i.getBoundingClientRect()}),{x:n.left-r.left+o,y:n.top-r.top+e}}function _(t,i,o){i=i||0,o=o||0;var e;return g(t,function(){e=t.getBoundingClientRect()}),{x:i-e.left,y:o-e.top}}function u(){var t,i,o,e,r,n=arguments[0]||{},a=typeof n,s=Object.prototype.toString,h=1,l=arguments.length,c=!1;for("boolean"===a&&(c=n,a=typeof(n=arguments[h]||{}),h++),"object"!==a&&"function"!==a&&(n={}),h===l&&(n=this,h--);h<l;h++)if(null!=(t=arguments[h]))for(i in t)o=n[i],n!==(e=t[i])&&(c&&e&&((r="[object Array]"===s.call(e))||"[object Object]"===s.call(e))?(r?(r=!1,o=o&&"[object Array]"===s.call(o)?o:[]):o=o&&"[object Object]"===s.call(o)?o:{},n[i]=u(c,o,e)):void 0!==e&&(n[i]=e));return n}function p(t,i){if("string"==typeof i){var o=t[i];i=t,t=o}if("function"==typeof t){var e=Array.prototype.slice,r=e.call(arguments,2),n=function(){return t.apply(i||this,r.concat(e.call(arguments)))};return n.guid=t.guid=t.guid||W++,n}}function g(t,i,o){"object"!=typeof t&&(t=[]),void 0===t.length&&(t=[t]);for(var e,r=[],n=[],a=0;e=t[a++];)for(;e instanceof HTMLElement;){var s=e.nodeName;if(!e.getClientRects().length){r.push(e),n.push(e.style.display);var h=R[s];if(!h){var l=document.createElement(s);document.body.appendChild(l),h=window.getComputedStyle(l).display,l.parentNode.removeChild(l),"none"===h&&(h="block"),R[s]=h}e.style.display=h}if("BODY"===s)break;e=e.parentNode}"function"==typeof i&&i.call(o||this);for(var c=r.length;c--;)r.pop().style.display=n.pop()}function d(t){return/%$/.test(t+"")}function m(t){return"number"==typeof t}function f(t){return"[object Array]"===Object.prototype.toString.call(t)}function y(t){return Array.prototype.map.call(t,function(t){return t})}function v(t,i,o,e){var r=document.createElement("DIV");if("object"==typeof i&&(e=i,i=null),"object"==typeof o&&(e=o,o=null),"object"==typeof e)for(var n in e)r.style[n]=e[n];return i&&(r.className=i),o&&(r.id=o),t.appendChild(r),r}function L(t){t.parentNode&&t.parentNode.removeChild(t)}function $(t,i){return t instanceof HTMLElement?[t]:"object"==typeof t&&t.length?y(t):t&&"string"==typeof t?("string"==typeof i&&(i=document.querySelector(i)),i instanceof HTMLElement||(i=document),y(i.querySelectorAll(t))):[]}function z(t,i,o){if("object"==typeof i){for(var e in i)t[e]=i[e];return t}return void 0===o?t[i]:(t[i]=o,t)}function b(t,i,o){if("object"==typeof i){for(var e in i)m(o=i[e])&&(o+="px"),t.style[e]=o;return t}return void 0===o?window.getComputedStyle(t)[i]:(m(o)&&(o+="px"),t.style[i]=o,t)}function S(t){var i=document.documentElement;if(t in i.style)return"";for(var o,e=t.charAt(0).toUpperCase()+t.substr(1),r=["Webkit","Moz","ms","O"],n=0;o=r[n++];)if(o+e in i.style)return"-"+o.toLowerCase()+"-"}var k=!!navigator.userAgent.match(/mobile/i),w=!!navigator.userAgent.match(/android/i),x=S("transition"),H=S("transform"),M=function(){},E={size:[100,100],adaptive:"",outputSize:[0,0],outputType:"jpg",outputQuality:.8,maxZoom:1,rotateFree:!w,view:"",file:"",ok:"",img:"",loadStart:M,loadComplete:M,loadError:M,done:M,fail:M,lrzOption:{width:w?1e3:void 0,height:w?1e3:void 0,quality:.7},style:{maskColor:"rgba(0,0,0,.5)",maskBorder:"2px dashed #ddd",jpgFillColor:"#fff"},errorMsg:{noSupport:"您的浏览器版本过于陈旧，无法支持裁图功能，请更换新的浏览器！",imgError:"不支持该图片格式，请选择常规格式的图片文件！",imgHandleError:"图片处理失败！请更换其它图片尝试。",imgLoadError:"图片读取失败！请更换其它图片尝试。",noImg:"没有可裁剪的图片！",clipError:"截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。"}},C=e.prototype;C.constructor=e,C._init=function(){var t=this,i=this._options;m(i.size)?i.size=[i.size,i.size]:f(i.size)?((!m(i.size[0])||i.size[0]<=0)&&(i.size[0]=E.size[0]),(!m(i.size[1])||i.size[1]<=0)&&(i.size[1]=E.size[1])):i.size=u({},E.size),m(i.outputSize)?i.outputSize=[i.outputSize,0]:f(i.outputSize)?((!m(i.outputSize[0])||i.outputSize[0]<0)&&(i.outputSize[0]=E.outputSize[0]),(!m(i.outputSize[1])||i.outputSize[1]<0)&&(i.outputSize[1]=E.outputSize[1])):i.outputSize=u({},E.outputSize),"jpg"===i.outputType?i.outputType="image/jpeg":i.outputType="image/png",f(i.adaptive)&&(this._widthIsPercent=!(!i.adaptive[0]||!d(i.adaptive[0]))&&i.adaptive[0],this._heightIsPercent=!(!i.adaptive[1]||!d(i.adaptive[1]))&&i.adaptive[1]),this._outputWidth=i.outputSize[0],this._outputHeight=i.outputSize[1],this._canvas=document.createElement("canvas"),this._iScroll=null,this._hammerManager=null,this._clipWidth=0,this._clipHeight=0,this._clipSizeRatio=1,this._$img=null,this._imgLoading=!1,this._imgLoaded=!1,this._containerWidth=0,this._containerHeight=0,this._$clipLayer=null,this._$moveLayer=null,this._$rotationLayer=null,this._viewList=null,this._fileList=null,this._okList=null,this._$mask=null,this._$mask_left=null,this._$mask_right=null,this._$mask_right=null,this._$mask_bottom=null,this._$clip_frame=null,this._atRotation=!1,this._rotationLayerWidth=0,this._rotationLayerHeight=0,this._rotationLayerX=0,this._rotationLayerY=0,this._rotationLayerOriginX=0,this._rotationLayerOriginY=0,this._curAngle=0,this._initProxy(),this._initElements(),this._initScroll(),this._initRotationEvent(),this._initFile(),this._resize(),window.addEventListener("resize",this._resize),(this._okList=$(i.ok))&&this._okList.forEach(function(i){i.addEventListener("click",t._clipImg)}),this._options.img&&this._lrzHandle(this._options.img)},C._initElements=function(){var t=this._$container,i=t.style,o={};o["user-select"]=i["user-select"],o.overflow=i.overflow,o.position=i.position,this._containerOriginStyle=o,b(t,{"user-select":"none",overflow:"hidden"}),"static"===b(t,"position")&&b(t,"position","relative"),this._$clipLayer=v(t,"photo-clip-layer",{position:"absolute",left:"50%",top:"50%"}),this._$moveLayer=v(this._$clipLayer,"photo-clip-move-layer"),this._$rotationLayer=v(this._$moveLayer,"photo-clip-rotation-layer");var e=this._$mask=v(t,"photo-clip-mask",{position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}),r=this._options,n=r.style.maskColor,a=r.style.maskBorder;if(this._$mask_left=v(e,"photo-clip-mask-left",{position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":n}),this._$mask_right=v(e,"photo-clip-mask-right",{position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":n}),this._$mask_top=v(e,"photo-clip-mask-top",{position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":n}),this._$mask_bottom=v(e,"photo-clip-mask-bottom",{position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":n}),this._$clip_frame=v(e,"photo-clip-area",{border:a,position:"absolute",left:"50%",top:"50%"}),this._viewList=$(r.view),this._viewList){var s=[];this._viewList.forEach(function(t,i){var o=t.style,e={};e["background-repeat"]=o["background-repeat"],e["background-position"]=o["background-position"],e["background-size"]=o["background-size"],s[i]=e,b(t,{"background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}),this._viewOriginStyleList=s}},C._initScroll=function(){this._iScroll=new t(this._$clipLayer,{zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,disablePointer:!0,disableTouch:!1,disableMouse:!1,wheelAction:"zoom",bounceTime:300})},C._refreshScroll=function(t){t=t||0;var i=this._iScroll.options,o=this._options.maxZoom,e=this._rotationLayerWidth,n=this._rotationLayerHeight;e&&n?(i.zoomMin=r(this._clipWidth,this._clipHeight,e,n),i.zoomMax=Math.max(o,i.zoomMin),i.startZoom=Math.min(i.zoomMax,r(this._containerWidth,this._containerHeight,e,n))):(i.zoomMin=1,i.zoomMax=o,i.startZoom=1),b(this._$moveLayer,{width:e,height:n}),this._$clipLayer.appendChild(this._$moveLayer),this._iScroll.refresh(t)},C._resetScroll=function(t,i){t=t||0,i=i||0,this._rotationLayerWidth=t,this._rotationLayerHeight=i,this._rotationLayerX=0,this._rotationLayerY=0,this._curAngle=0,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle),b(this._$rotationLayer,{width:t,height:i}),this._refreshScroll();var o=this._iScroll,e=o.scale,r=.5*(this._clipWidth-t*e),n=.5*(this._clipHeight-i*e);o.scrollTo(r,n),o.zoom(o.options.startZoom,void 0,void 0,0)},C._initRotationEvent=function(){if(k){this._hammerManager=new i.Manager(this._$moveLayer),this._hammerManager.add(new i.Rotate);var t,o,e,r=this,n=this._options.rotateFree,a=this._iScroll.options.bounceTime;this._hammerManager.on("rotatestart",function(i){r._atRotation||(t=!0,n?(o=(i.rotation-r._curAngle)%360,r._rotationLayerRotateReady(i.center)):o=i.rotation)}),this._hammerManager.on("rotatemove",function(i){t&&(e=i.rotation-o,n&&r._rotationLayerRotate(e))}),this._hammerManager.on("rotateend rotatecancel",function(i){if(t){if(t=!1,!n)return e%=360,e>180?e-=360:e<-180&&(e+=360),void(e>30?r._rotateBy(90,a,i.center):e<-30&&r._rotateBy(-90,a,i.center));var o=e%360;o<0&&(o+=360),o<10?e+=-o:o>80&&o<100?e+=90-o:o>170&&o<190?e+=180-o:o>260&&o<280?e+=270-o:o>350&&(e+=360-o),r._rotationLayerRotateFinish(e,a)}})}else this._$moveLayer.addEventListener("dblclick",this._rotateCW90)},C._rotateCW90=function(t){this._rotateBy(90,this._iScroll.options.bounceTime,{x:t.clientX,y:t.clientY})},C._rotateBy=function(t,i,o){this._rotateTo(this._curAngle+t,i,o)},C._rotateTo=function(t,i,o){this._atRotation||(this._rotationLayerRotateReady(o),this._rotationLayerRotateFinish(t,i))},C._rotationLayerRotateReady=function(t){var i,o=this._iScroll.scale;(i=t?_(this._$rotationLayer,t.x,t.y):c(this._$rotationLayer,this._$clipLayer,.5*this._clipWidth,.5*this._clipHeight)).x/=o,i.y/=o;var e=h({x:i.x-this._rotationLayerX,y:i.y-this._rotationLayerY},-this._curAngle);this._rotationLayerOriginX=e.x,this._rotationLayerOriginY=e.y;var r=this._$rotationLayer.getBoundingClientRect();n(this._$rotationLayer,this._rotationLayerOriginX,this._rotationLayerOriginY);var s=this._$rotationLayer.getBoundingClientRect();this._rotationLayerX+=(r.left-s.left)/o,this._rotationLayerY+=(r.top-s.top)/o,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle)},C._rotationLayerRotate=function(t){a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,t),this._curAngle=t},C._rotationLayerRotateFinish=function(t,i){a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,t);var o=this._$rotationLayer.getBoundingClientRect();n(this._$rotationLayer,0,0);var e=this._$rotationLayer.getBoundingClientRect();a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,0);var r=this._$rotationLayer.getBoundingClientRect(),h=this._$moveLayer.getBoundingClientRect(),l={x:o.left-h.left,y:o.top-h.top},c=this._iScroll,_=c.scale;this._rotationLayerWidth=o.width/_,this._rotationLayerHeight=o.height/_,this._rotationLayerX=(r.left-e.left)/_,this._rotationLayerY=(r.top-e.top)/_,c.scrollTo(c.x+l.x,c.y+l.y),this._refreshScroll(c.options.bounceTime);var u=Math.max(c.options.zoomMin,Math.min(c.options.zoomMax,_));if(u!==_&&(l.x=l.x/_*u,l.y=l.y/_*u),c.startX+=l.x,c.startY+=l.y,t!==this._curAngle&&i&&m(i)&&void 0!==x){l={x:(e.left-o.left)/_,y:(e.top-o.top)/_},n(this._$rotationLayer,this._rotationLayerOriginX,this._rotationLayerOriginY),a(this._$rotationLayer,this._rotationLayerX+l.x,this._rotationLayerY+l.y,this._curAngle);var p=this;this._atRotation=!0,s(this._$rotationLayer,this._rotationLayerX+l.x,this._rotationLayerY+l.y,t,i,function(){p._atRotation=!1,p._rotateFinishUpdataElem(t)})}else this._rotateFinishUpdataElem(t)},C._rotateFinishUpdataElem=function(t){n(this._$rotationLayer,this._rotationLayerOriginX=0,this._rotationLayerOriginY=0),a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle=t%360)},C._initFile=function(){var t=this,i=this._options;i.errorMsg;(this._fileList=$(i.file))&&this._fileList.forEach(function(i){k||z(i,"accept","image/jpeg, image/x-png, image/gif"),i.addEventListener("change",t._fileOnChangeHandle)})},C._fileOnChangeHandle=function(t){var i=t.target.files;i.length&&this._lrzHandle(i[0])},C._lrzHandle=function(t){var i=this,e=this._options,r=e.errorMsg;if("object"==typeof t&&t.type&&!/image\/\w+/.test(t.type))return e.loadError.call(this,r.imgError),!1;this._imgLoaded=!1,this._imgLoading=!0,e.loadStart.call(this,t);try{o(t,e.lrzOption).then(function(t){i._clearImg(),i._createImg(t.base64)}).catch(function(t){e.loadError.call(i,r.imgHandleError,t),i._imgLoading=!1})}catch(t){throw t}},C._clearImg=function(){this._$img&&(this._$img.onload=null,this._$img.onerror=null,L(this._$img),this._$img=null)},C._createImg=function(t){var i=this,o=this._options,e=o.errorMsg;this._$img=new Image,b(this._$img,{"user-select":"none","pointer-events":"none"}),this._$img.onload=function(){i._imgLoaded=!0,i._imgLoading=!1,o.loadComplete.call(i,this),i._$rotationLayer.appendChild(this),g([this,i._$moveLayer],function(){i._resetScroll(this.naturalWidth,this.naturalHeight)},this)},this._$img.onerror=function(t){o.loadError.call(i,e.imgLoadError,t),i._imgLoading=!1},z(this._$img,"src",t)},C._clipImg=function(){var t=this._options,i=t.errorMsg;if(!this._imgLoaded)return void t.fail.call(this,i.noImg);var o=c(this._$rotationLayer,this._$clipLayer),e=this._iScroll.scale,r=1,n=1,a=this._canvas.getContext("2d");this._outputWidth||this._outputHeight?(this._canvas.width=this._outputWidth,this._canvas.height=this._outputHeight,r=this._outputWidth/this._clipWidth*e,n=this._outputHeight/this._clipHeight*e):(this._canvas.width=this._clipWidth/e,this._canvas.height=this._clipHeight/e),a.clearRect(0,0,this._canvas.width,this._canvas.height),a.fillStyle=t.style.jpgFillColor,a.fillRect(0,0,this._canvas.width,this._canvas.height),a.save(),a.scale(r,n),a.translate(this._rotationLayerX-o.x/e,this._rotationLayerY-o.y/e),a.rotate(this._curAngle*Math.PI/180),a.drawImage(this._$img,0,0),a.restore();try{var s=this._canvas.toDataURL(t.outputType,t.outputQuality);return this._viewList&&this._viewList.forEach(function(t,i){b(t,"background-image","url("+s+")")}),t.done.call(this,s),s}catch(o){t.fail.call(this,i.clipError,o)}},C._resize=function(t,i){g(this._$container,function(){this._containerWidth=this._$container.offsetWidth,this._containerHeight=this._$container.offsetHeight},this);var o=this._options.size,e=this._clipWidth,r=this._clipHeight;if(m(t)&&(o[0]=t),m(i)&&(o[1]=i),this._widthIsPercent||this._heightIsPercent){var n=o[0]/o[1];this._widthIsPercent&&(this._clipWidth=this._containerWidth/100*parseFloat(this._widthIsPercent),this._heightIsPercent||(this._clipHeight=this._clipWidth/n)),this._heightIsPercent&&(this._clipHeight=this._containerHeight/100*parseFloat(this._heightIsPercent),this._widthIsPercent||(this._clipWidth=this._clipHeight*n))}else this._clipWidth=o[0],this._clipHeight=o[1];var a=this._clipWidth,s=this._clipHeight;if(this._clipSizeRatio=a/s,this._outputWidth&&!this._outputHeight&&(this._outputHeight=this._outputWidth/this._clipSizeRatio),this._outputHeight&&!this._outputWidth&&(this._outputWidth=this._outputHeight*this._clipSizeRatio),b(this._$clipLayer,{width:a,height:s,"margin-left":-a/2,"margin-top":-s/2}),b(this._$mask_left,{"margin-right":a/2,"margin-top":-s/2,"margin-bottom":-s/2}),b(this._$mask_right,{"margin-left":a/2,"margin-top":-s/2,"margin-bottom":-s/2}),b(this._$mask_top,{"margin-bottom":s/2}),b(this._$mask_bottom,{"margin-top":s/2}),b(this._$clip_frame,{width:a,height:s}),b(this._$clip_frame,H+"transform","translate(-50%, -50%)"),a!==e||s!==r){this._refreshScroll();var h=this._iScroll,l=h.scale,c=.5*(a-e)*l,_=.5*(s-r)*l;h.scrollBy(c,_);var u=Math.max(h.options.zoomMin,Math.min(h.options.zoomMax,l));u!==l&&h.zoom(u,void 0,void 0,0)}},C._initProxy=function(){this._fileOnChangeHandle=p(this,"_fileOnChangeHandle"),this._rotateCW90=p(this,"_rotateCW90"),this._resize=p(this,"_resize"),this._clipImg=p(this,"_clipImg"),this.size=p(this,"size"),this.load=p(this,"load"),this.rotateBy=p(this,"rotateBy"),this.rotateTo=p(this,"rotateTo"),this.clip=p(this,"clip"),this.destroy=p(this,"destroy")},C.size=function(t,i){return this._resize(t,i),this},C.load=function(t){return this._lrzHandle(t),this},C.clear=function(){return this._clearImg(),this._resetScroll(),this._fileList&&this._fileList.forEach(function(t){t.value=""}),this},C.rotate=function(t,i){return void 0===t?this._curAngle:(this._rotateTo(t,i),this)},C.scale=function(t,i){return void 0===t?this._iScroll.scale:(this._iScroll.zoom(t,void 0,void 0,i),this)},C.clip=function(){return this._clipImg()},C.destroy=function(){var t=this;window.removeEventListener("resize",this._resize),this._$container.removeChild(this._$clipLayer),this._$container.removeChild(this._$mask),b(this._$container,this._containerOriginStyle),this._iScroll&&this._iScroll.destroy(),this._hammerManager?(this._hammerManager.off("rotatemove"),this._hammerManager.off("rotateend"),this._hammerManager.destroy()):this._$moveLayer.removeEventListener("dblclick",this._rotateCW90),this._$img&&(this._$img.onload=null,this._$img.onerror=null),this._viewList&&this._viewList.forEach(function(i,o){b(i,t._viewOriginStyleList[o])}),this._fileList&&this._fileList.forEach(function(i){i.removeEventListener("change",t._fileOnChangeHandle)}),this._okList&&this._okList.forEach(function(i){i.removeEventListener("click",t._clipImg)});for(var i in this)delete this[i];this.__proto__=Object.prototype};var W=0,R={};return e});